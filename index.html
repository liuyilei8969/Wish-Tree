<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>âœ¨ å¿ƒæ„¿è¿›åŒ–æ ‘ âœ¨</title>
    <style>
        * { box-sizing: border-box; }
        body { 
            text-align: center; 
            background: #ffffff; 
            font-family: "Microsoft YaHei", "PingFang SC", sans-serif; 
            margin: 0; 
            padding: 0; 
            overflow-y: auto; 
            overflow-x: hidden; 
            scroll-behavior: smooth; 
            transition: background-color 2s ease; 
        }
        
        h1 { margin-top: 20px; font-size: 32px; color: #333; transition: opacity 0.3s; }
        .sub-title { font-size: 18px; color: #555; font-weight: normal; margin-top: -10px; margin-bottom: 10px; transition: opacity 0.3s; }
        .tips { color: #888; font-size: 14px; margin-bottom: 20px; transition: all 0.3s ease; }

        .nav-bar {
            position: sticky;
            top: 0;
            background: rgba(255, 255, 255, 0.9);
            padding: 10px;
            z-index: 500;
            display: flex;
            justify-content: center;
            gap: 10px;
            backdrop-filter: blur(5px);
            border-bottom: 1px solid #f0f0f0;
        }

        .nav-btn {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 14px;
            font-weight: bold;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        .nav-btn.secondary { background: #FF9800; }

        /* çˆ±å‘ç”µé£æ ¼æŒ‰é’® */
        .afdian-btn {
            background: #8a2be2;
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 10px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            margin: 15px 0;
            width: 100%;
            display: inline-block;
            text-decoration: none;
            transition: background 0.3s;
        }
        .afdian-btn:hover { background: #7a1fd1; }

        .stats-board {
            display: flex;
            justify-content: center;
            gap: 30px;
            margin: 10px auto;
            padding: 10px 20px;
            background: rgba(253, 253, 253, 0.8);
            border-radius: 12px;
            width: fit-content;
            box-shadow: 0 2px 10px rgba(0,0,0,0.03);
            border: 1px solid #f0f0f0;
            backdrop-filter: blur(5px);
        }

        .stat-item { display: flex; flex-direction: column; align-items: center; }
        .stat-value { font-size: 20px; font-weight: bold; color: #333; }
        .stat-label { font-size: 12px; color: #999; margin-top: 2px; }

        #tree-container {
            position: relative;
            display: block;
            margin: 0 auto 60px auto; 
            width: 95vw;
            max-width: 1000px;
            cursor: crosshair;
        }

        #bg-tree { width: 100%; height: auto; display: block; }

        .item {
            position: absolute;
            transform: translate(-50%, -50%);
            cursor: pointer;
            z-index: 10;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.5s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .item.size-small { width: 25px; height: 25px; }
        .item.size-large { width: 50px; height: 50px; z-index: 11; }
        .item img { width: 100%; height: 100%; object-fit: contain; pointer-events: none; }

        .wish-content {
            position: absolute;
            width: 80%;
            font-size: 0px; 
            color: #000000;
            font-weight: 900;
            text-align: center;
            pointer-events: none;
            line-height: 1.3;
            z-index: 11;
            opacity: 0;
            transition: all 0.3s;
            text-shadow: 0 0 5px #ffffff, 0 0 10px #ffffff, 0 0 15px #ffffff, 0 0 20px #ffffff;
        }

        .interaction-bar {
            position: absolute;
            bottom: -60px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 10px;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s;
        }

        .action-btn {
            background: rgba(255, 255, 255, 0.9);
            border: 1px solid #eee;
            padding: 8px 12px;
            border-radius: 20px;
            font-size: 13px;
            color: #333;
            cursor: pointer;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
            display: flex;
            align-items: center;
            gap: 5px;
            white-space: nowrap;
        }

        .item.full-screen {
            position: fixed;
            top: 50% !important;
            left: 50% !important;
            width: 85vw !important; 
            height: 85vw !important;
            max-width: 550px;
            max-height: 550px;
            z-index: 1000;
            transform: translate(-50%, -50%);
        }

        .item.full-screen .wish-content { font-size: clamp(18px, 5vw, 28px); opacity: 1; }
        .item.full-screen .interaction-bar { opacity: 1; pointer-events: auto; }

        #overlay {
            display: none;
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background: rgba(255, 255, 255, 0.85);
            backdrop-filter: blur(8px);
            z-index: 900;
        }

        .modal {
            display: none;
            position: fixed;
            top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 25px;
            border-radius: 20px;
            box-shadow: 0 15px 50px rgba(0,0,0,0.15);
            z-index: 2000;
            width: 320px;
        }

        input, select { 
            width: 100%; padding: 12px; margin: 10px 0; 
            border: 1px solid #eee; border-radius: 10px; 
            box-sizing: border-box; font-size: 16px; outline: none;
        }
        
        button { 
            width: 100%; padding: 12px; border: none; 
            border-radius: 10px; cursor: pointer; 
            font-weight: bold; font-size: 16px;
        }

        .pay-hint { font-size: 13px; color: #666; margin: 15px 0; line-height: 1.6; }
        .passcode-display { font-size: 20px; letter-spacing: 2px; color: #FF9800; font-weight: bold; margin: 10px 0; }
        .disclaimer { font-size: 10px; color: #bbb; margin: 20px auto; max-width: 600px; padding: 0 20px; }
        
        .loading-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: white; display: flex; align-items: center; justify-content: center;
            z-index: 3000; flex-direction: column;
        }
    </style>
</head>
<body>

    <div id="loading" class="loading-overlay">
        <h3>âœ¨ æ­£åœ¨è¿æ¥å¿ƒæ„¿æ ‘...</h3>
        <p id="loading-status" style="color:#999; font-size:12px;">æ­£åœ¨åˆå§‹åŒ–èº«ä»½éªŒè¯</p>
    </div>

    <div id="overlay" onclick="closeAll()"></div>

    <div class="nav-bar">
        <button class="nav-btn" onclick="openWishModal()">æˆ‘è¦è®¸æ„¿</button>
        <button class="nav-btn secondary" onclick="openRedeemModal()">è¿˜æ„¿/æ‰¾å›å¿ƒæ„¿</button>
    </div>

    <h1>âœ¨ å¿ƒæ„¿è¿›åŒ–æ ‘ âœ¨</h1>
    <p id="sub-title-text" class="sub-title">âœ¨ è¯·åœ¨è¿™é‡Œè®¸ä¸‹å¿ƒæ„¿å§ï¼</p>
    
    <div class="stats-board">
        <div class="stat-item">
            <span class="stat-value" id="total-count">0</span>
            <span class="stat-label">å¿ƒæ„¿æ€»æ•°</span>
        </div>
        <div class="stat-item">
            <span class="stat-value" id="fulfilled-count" style="color: #FF9800;">0</span>
            <span class="stat-label">å·²è¾¾æˆå¿ƒæ„¿</span>
        </div>
    </div>

    <p id="main-tips" class="tips">ğŸƒ å°å°å¿ƒæ„¿5å…ƒ | ğŸŒ¸ è‡³è¯šé”¦æ„¿10å…ƒ | å…ˆæ’­ç§åæ”¯æŒï¼Œå…¨å‡­è‡ªæ„¿</p>

    <div id="tree-container">
        <img src="tree.png" id="bg-tree">
        <div id="items-layer"></div>
    </div>

    <div id="modal" class="modal">
        <h3>è®¸ä¸‹ä½ çš„æ„¿æœ›</h3>
        <input type="text" id="wishText" placeholder="å†™ä¸‹ä½ çš„æ„¿æœ›å§...">
        <select id="wishType">
            <option value="green_leaf">ğŸƒ å°å°å¿ƒæ„¿ (æ”¯æŒ5å…ƒ - ç»¿å¶)</option>
            <option value="flower">ğŸŒ¸ è‡³è¯šé”¦æ„¿ (æ”¯æŒ10å…ƒ - é²œèŠ±)</option>
        </select>
        <button class="btn-pay" onclick="confirmWishAndShowPay()" style="background: #4CAF50; color: white;">ç«‹å³æ’­ç§</button>
        <button class="btn-cancel" onclick="closeModal()" style="background: #f5f5f5; color: #999; margin-top: 8px;">å–æ¶ˆ</button>
    </div>

    <div id="successModal" class="modal">
        <h3 style="color: #4CAF50;">æ’­ç§æˆåŠŸ âœ¨</h3>
        <p class="pay-hint">æ‚¨çš„å¿ƒæ„¿å·²æŒ‚åœ¨æ ‘ä¸Šã€‚è¯·åŠ¡å¿…ä¿å­˜æå–ç ï¼š</p>
        <div class="passcode-display" id="displayPasscode">--------</div>
        
        <div style="padding: 15px; background: #f9f9f9; border-radius: 10px; margin-top: 10px;">
            <p style="font-size: 11px; color: #888; margin-bottom: 5px;">[ éšå–œæ”¯æŒå¼€å‘è€…ç»´æŠ¤æœ¬é¡¹ç›® ]</p>
            <!-- åœ¨ä¸‹æ–¹å¼•å·å†…å¡«å…¥ä½ çš„çˆ±å‘ç”µä¸»é¡µ URL -->
            <a href="https://afdian.com/a/star2moon" target="_blank" class="afdian-btn">å‰å¾€çˆ±å‘ç”µæ”¯æŒæˆ‘</a>
            <p style="font-size: 10px; color: #aaa;">å¼€å‘è€… GitHub: liuyilei8969</p>
        </div>
        
        <p class="pay-hint" style="font-size: 11px;">æˆ‘ä»¬åšæŒâ€œå…ˆæ’­ç§ã€åæ”¯æŒâ€çš„åŸåˆ™ã€‚<br>æ‚¨çš„æ”¯æŒå°†ç”¨äºæœåŠ¡å™¨ç»­è´¹åŠåç»­å¼€å‘ã€‚</p>
        <button class="btn-pay" onclick="closeAll()" style="background: #4CAF50; color: white;">å¥½çš„</button>
    </div>

    <div id="redeemModal" class="modal">
        <h3>æ‰¾å›æˆ‘çš„å¿ƒæ„¿</h3>
        <input type="text" id="redeemCode" maxlength="8" placeholder="è¾“å…¥æå–ç " style="text-transform: uppercase;">
        <button class="btn-pay" onclick="handleRedeem()" style="background: #FF9800; color: white;">å¼€å§‹æŸ¥æ‰¾</button>
        <button class="btn-cancel" onclick="closeModal()" style="background: #f5f5f5; color: #999; margin-top: 8px;">å–æ¶ˆ</button>
    </div>

    <div class="disclaimer">
        * å…è´£å£°æ˜ï¼šæœ¬ç½‘ç«™ä»…ä¸ºä¸ªäººæŠ€æœ¯äº’åŠ¨å®éªŒé¡¹ç›®ã€‚å¿ƒæ„¿æ’­ç§ä¸æ‰“èµå‡å±è‡ªæ„¿èµ ä¸è¡Œä¸ºã€‚
    </div>

    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, updateDoc, deleteDoc, doc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {
            apiKey: "AIzaSyCskcwc_od5y7ibmCzhk4BJDbzpq2I_RHQ",
            authDomain: "wishtree-dd4d6.firebaseapp.com",
            projectId: "wishtree-dd4d6",
            storageBucket: "wishtree-dd4d6.firebasestorage.app",
            messagingSenderId: "528466950558",
            appId: "1:528466950558:web:3b8f300319cc7f12cbfe8f"
        };
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'wish-tree-default';

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        let user = null;
        let unsubscribeWishes = null;

        const layer = document.getElementById('items-layer');
        const container = document.getElementById('tree-container');
        const overlay = document.getElementById('overlay');
        const subTitle = document.getElementById('sub-title-text');
        const mainTips = document.getElementById('main-tips');
        const loadingStatus = document.getElementById('loading-status');
        let curX, curY;
        const MAX_WISHES_FOR_GOLD = 100;

        const initAuth = async () => {
            try {
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    await signInWithCustomToken(auth, __initial_auth_token);
                } else {
                    await signInAnonymously(auth);
                }
            } catch (err) {
                loadingStatus.innerText = "è®¤è¯å¤±è´¥ï¼Œè¯·æ£€æŸ¥é…ç½®ã€‚";
            }
        };

        onAuthStateChanged(auth, (u) => {
            user = u;
            if (user) {
                loadingStatus.innerText = "æ•°æ®è½½å…¥ä¸­...";
                startListening();
            }
        });

        function startListening() {
            if (!user) return;
            if (unsubscribeWishes) unsubscribeWishes();
            const wishesCol = collection(db, 'artifacts', appId, 'public', 'data', 'wishes');
            unsubscribeWishes = onSnapshot(wishesCol, (snapshot) => {
                document.getElementById('loading').style.display = 'none';
                layer.innerHTML = '';
                let total = 0, fulfilled = 0;
                snapshot.forEach((docSnap) => {
                    const data = docSnap.data();
                    renderItem(docSnap.id, data);
                    total++;
                    if (data.type === 'gold_leaf' || data.type === 'apple') fulfilled++;
                });
                document.getElementById('total-count').innerText = total;
                document.getElementById('fulfilled-count').innerText = fulfilled;
                updateBackground(total);
            });
        }

        initAuth();

        function updateBackground(total) {
            const ratio = Math.min(total / MAX_WISHES_FOR_GOLD, 1);
            const g = Math.floor(255 - 40 * ratio);
            const b = Math.floor(255 - 255 * ratio);
            document.body.style.backgroundColor = `rgb(255, ${g}, ${b})`;
        }

        function renderItem(id, data) {
            const div = document.createElement('div');
            const isLarge = (data.type === 'flower' || data.type === 'apple');
            div.className = `item ${isLarge ? 'size-large' : 'size-small'}`;
            div.style.left = data.x + '%';
            div.style.top = data.y + '%';
            div.dataset.passcode = data.passcode;
            div.innerHTML = `
                <img src="${data.type}.png" class="item-img" onerror="this.src='data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 width=%2220%22 height=%2220%22><circle cx=%2210%22 cy=%2210%22 r=%228%22 fill=%22green%22/></svg>'">
                <div class="wish-content">${data.text}</div>
                <div class="interaction-bar">
                    <div class="action-btn like-btn">â¤ï¸ <span class="count">${data.likes || 0}</span></div>
                    <div class="action-btn bless-btn">âœ¨ <span class="count">${data.blessings || 0}</span></div>
                    <div class="action-btn" style="color:#f44336;" onclick="window.handleCancelWish('${id}', '${data.passcode}', event)">ğŸ—‘ï¸ ç§»é™¤</div>
                </div>
            `;
            div.querySelector('.like-btn').onclick = (e) => {
                e.stopPropagation();
                updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'wishes', id), { likes: (data.likes || 0) + 1 });
            };
            div.querySelector('.bless-btn').onclick = (e) => {
                e.stopPropagation();
                updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'wishes', id), { blessings: (data.blessings || 0) + 1 });
            };
            div.onclick = (e) => {
                e.stopPropagation();
                if(div.classList.contains('full-screen')) window.evolveItem(id, data.type, data.passcode);
                else window.openFullScreen(div);
            };
            layer.appendChild(div);
        }

        window.openWishModal = () => {
            container.scrollIntoView({ behavior: 'smooth', block: 'center' });
            mainTips.innerHTML = "<strong>âœ¨ è¯·ç‚¹å‡»æ ‘ææ’­ç§å¿ƒæ„¿ âœ¨</strong>";
            mainTips.style.color = "#4CAF50";
        };

        window.openRedeemModal = () => {
            document.getElementById('redeemModal').style.display = 'block';
            overlay.style.display = 'block';
        };

        container.onclick = (e) => {
            if(e.target !== container && e.target !== document.getElementById('bg-tree')) return;
            const rect = container.getBoundingClientRect();
            curX = ((e.clientX - rect.left) / rect.width) * 100;
            curY = ((e.clientY - rect.top) / rect.height) * 100;
            document.getElementById('modal').style.display = 'block';
            overlay.style.display = 'block';
        };

        window.confirmWishAndShowPay = async () => {
            const text = document.getElementById('wishText').value.trim();
            const type = document.getElementById('wishType').value;
            if(!text || !user) return;
            const passcode = Math.random().toString(36).substring(2, 10).toUpperCase();
            await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'wishes'), {
                x: curX, y: curY, text, type, passcode, likes: 0, blessings: 0, createdAt: new Date()
            });
            document.getElementById('modal').style.display = 'none';
            document.getElementById('displayPasscode').innerText = passcode;
            document.getElementById('successModal').style.display = 'block';
            document.getElementById('wishText').value = '';
        };

        window.handleRedeem = () => {
            const code = document.getElementById('redeemCode').value.trim().toUpperCase();
            const found = Array.from(document.querySelectorAll('.item')).find(el => el.dataset.passcode === code);
            if (found) {
                window.closeModal();
                found.scrollIntoView({ behavior: 'smooth', block: 'center' });
                window.openFullScreen(found);
            } else alert("æœªæ‰¾åˆ°è¯¥æå–ç ã€‚");
        };

        window.handleCancelWish = async (id, correctCode, e) => {
            e.stopPropagation();
            const input = prompt("è¯·è¾“å…¥æå–ç ä»¥ç§»é™¤ï¼š");
            if(input && input.toUpperCase() === correctCode) {
                await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'wishes', id));
                window.closeAll();
            } else if(input) alert("æå–ç é”™è¯¯ã€‚");
        };

        window.evolveItem = async (id, currentType, correctCode) => {
            if(currentType === 'gold_leaf' || currentType === 'apple') return;
            const input = prompt("å¿ƒæ„¿è¾¾æˆäº†å—ï¼Ÿè¾“å…¥æå–ç è¿›åŒ–æœå®ï¼š");
            if(input && input.toUpperCase() === correctCode) {
                const nextType = (currentType === 'green_leaf') ? 'gold_leaf' : 'apple';
                await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'wishes', id), { type: nextType });
                window.closeAll();
            } else if(input) alert("æå–ç é”™è¯¯ã€‚");
        };

        window.openFullScreen = (el) => {
            window.closeAll();
            overlay.style.display = 'block';
            el.classList.add('full-screen');
            document.querySelector('h1').style.opacity = '0';
            subTitle.style.opacity = '0';
            document.querySelector('.stats-board').style.opacity = '0';
            mainTips.style.opacity = '0';
            document.body.style.overflow = 'hidden';
        };

        window.closeAll = () => {
            document.querySelectorAll('.item.full-screen').forEach(el => el.classList.remove('full-screen'));
            overlay.style.display = 'none';
            document.querySelectorAll('.modal').forEach(m => m.style.display = 'none');
            document.querySelector('h1').style.opacity = '1';
            subTitle.style.opacity = '1';
            document.querySelector('.stats-board').style.opacity = '1';
            mainTips.style.opacity = '1';
            document.body.style.overflow = 'auto';
        };

        window.closeModal = () => {
            document.querySelectorAll('.modal').forEach(m => m.style.display = 'none');
            overlay.style.display = 'none';
            document.body.style.overflow = 'auto';
        };
    </script>
</body>
</html>


