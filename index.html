<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>âœ¨ å¿ƒæ„¿è¿›åŒ–æ ‘ âœ¨</title>
    <style>
        * { box-sizing: border-box; }
        body { 
            text-align: center; background: #ffffff; 
            font-family: "Microsoft YaHei", "PingFang SC", sans-serif; 
            margin: 0; padding: 0; overflow-y: auto; overflow-x: hidden; 
            scroll-behavior: smooth; transition: background-color 2s ease; 
        }
        h1 { margin-top: 20px; font-size: 28px; color: #333; transition: opacity 0.3s; padding: 0 10px; }
        .sub-title { font-size: 16px; color: #555; font-weight: normal; margin-top: -10px; margin-bottom: 10px; }
        .tips { color: #888; font-size: 13px; margin-bottom: 10px; padding: 0 15px; }

        .support-container { margin-bottom: 20px; }
        .mini-support-btn {
            display: inline-flex; align-items: center; gap: 5px; background: #946ce6; color: white !important;
            text-decoration: none; font-size: 12px; font-weight: bold; padding: 6px 15px; border-radius: 15px;
            box-shadow: 0 2px 8px rgba(148, 108, 230, 0.2); transition: all 0.3s;
        }

        .nav-bar {
            position: sticky; top: 0; background: rgba(255, 255, 255, 0.9); padding: 10px; z-index: 500;
            display: flex; justify-content: center; gap: 10px; backdrop-filter: blur(5px); border-bottom: 1px solid #f0f0f0;
        }

        .nav-btn {
            background: #4CAF50; color: white; border: none; padding: 8px 16px; border-radius: 20px;
            cursor: pointer; font-size: 14px; font-weight: bold; box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        .nav-btn.secondary { background: #FF9800; }

        .stats-board {
            display: flex; justify-content: center; gap: 20px; margin: 10px auto; padding: 10px 15px;
            background: rgba(253, 253, 253, 0.8); border-radius: 12px; width: fit-content;
            box-shadow: 0 2px 10px rgba(0,0,0,0.03); border: 1px solid #f0f0f0;
        }

        #tree-container { position: relative; display: block; margin: 0 auto 60px auto; width: 95vw; max-width: 1000px; cursor: crosshair; }
        #bg-tree { width: 100%; height: auto; display: block; }

        .item {
            position: absolute; transform: translate(-50%, -50%); cursor: pointer; z-index: 10;
            display: flex; align-items: center; justify-content: center; transition: all 0.5s;
        }
        .item.size-small { width: 25px; height: 25px; }
        .item.size-large { width: 50px; height: 50px; }
        .item img { width: 100%; height: 100%; object-fit: contain; pointer-events: none; }

        .interaction-bar {
            position: absolute; bottom: -60px; left: 50%; transform: translateX(-50%);
            display: flex; gap: 10px; opacity: 0; pointer-events: none; transition: opacity 0.3s;
        }

        .item.full-screen {
            position: fixed; top: 50% !important; left: 50% !important; width: 85vw !important; height: 85vw !important;
            max-width: 500px; max-height: 500px; z-index: 1000; transform: translate(-50%, -50%);
        }

        #overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255, 255, 255, 0.85); backdrop-filter: blur(8px); z-index: 900; }

        .modal {
            display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
            background: white; padding: 20px; border-radius: 20px; box-shadow: 0 15px 50px rgba(0,0,0,0.15);
            z-index: 2000; width: 85%; max-width: 320px;
        }

        /* åŠ è½½é¡µè‡ªæ•‘è®¾è®¡ */
        .loading-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: white; display: flex; align-items: center; justify-content: center;
            z-index: 3000; flex-direction: column; padding: 20px;
        }
        .skip-btn {
            margin-top: 20px; background: #eee; border: none; padding: 8px 15px; 
            border-radius: 10px; font-size: 12px; color: #666; cursor: pointer; display: none;
        }
    </style>
</head>
<body>

    <div id="loading" class="loading-overlay">
        <h3>âœ¨ æ­£åœ¨è¿æ¥å¿ƒæ„¿æ ‘...</h3>
        <p id="loading-status" style="color:#999; font-size:12px;">æ­£åœ¨åˆå§‹åŒ–äº‘ç«¯åŒæ­¥</p>
        <button id="skip-loading" class="skip-btn" onclick="document.getElementById('loading').style.display='none'">
            è¿æ¥è¾ƒæ…¢ï¼Ÿç‚¹å‡»ç›´æ¥è¿›å…¥
        </button>
    </div>

    <div id="overlay" onclick="closeAll()"></div>

    <div class="nav-bar">
        <button class="nav-btn" onclick="openWishModal()">æˆ‘è¦è®¸æ„¿</button>
        <button class="nav-btn secondary" onclick="openRedeemModal()">æ‰¾å›å¿ƒæ„¿</button>
    </div>

    <h1>âœ¨ å¿ƒæ„¿è¿›åŒ–æ ‘ âœ¨</h1>
    <p class="sub-title">âœ¨ è¯·åœ¨è¿™é‡Œè®¸ä¸‹å¿ƒæ„¿å§ï¼</p>
    
    <div class="stats-board">
        <div class="stat-item">
            <span class="stat-value" id="total-count">0</span>
            <span class="stat-label">å¿ƒæ„¿æ€»æ•°</span>
        </div>
        <div class="stat-item">
            <span class="stat-value" id="fulfilled-count" style="color: #FF9800;">0</span>
            <span class="stat-label">å·²è¾¾æˆ</span>
        </div>
    </div>

    <p id="main-tips" class="tips">ğŸƒ å°å°å¿ƒæ„¿ 5å…ƒ | ğŸŒ¸ è‡³è¯šé”¦æ„¿ 10å…ƒ | å…ˆæ’­ç§åæ”¯æŒ</p>
    
    <div class="support-container">
        <a href="https://afdian.com/a/star2moon" target="_blank" class="mini-support-btn">ğŸ’œ æ”¯æŒå¼€å‘è€…</a>
    </div>

    <div id="tree-container">
        <img src="tree.png" id="bg-tree">
        <div id="items-layer"></div>
    </div>

    <!-- å¼¹çª—ç»„ä»¶ -->
    <div id="modal" class="modal">
        <h3>è®¸ä¸‹ä½ çš„æ„¿æœ›</h3>
        <input type="text" id="wishText" placeholder="å†™ä¸‹ä½ çš„æ„¿æœ›å§...">
        <select id="wishType">
            <option value="green_leaf">ğŸƒ å°å°å¿ƒæ„¿ (5å…ƒ - ç»¿å¶)</option>
            <option value="flower">ğŸŒ¸ è‡³è¯šé”¦æ„¿ (10å…ƒ - é²œèŠ±)</option>
        </select>
        <button class="nav-btn" style="width:100%; margin-top:10px" onclick="confirmWishAndShowPay()">ç«‹å³æ’­ç§</button>
        <button class="nav-btn" style="width:100%; margin-top:10px; background:#f5f5f5; color:#999" onclick="closeModal()">å–æ¶ˆ</button>
    </div>

    <div id="successModal" class="modal">
        <h3 style="color: #4CAF50;">æ’­ç§æˆåŠŸ âœ¨</h3>
        <p style="font-size:12px">è¯·ä¿å­˜æå–ç ï¼š</p>
        <div id="displayPasscode" style="font-size:24px; font-weight:bold; color:#FF9800; background:#fff8e1; padding:10px; margin:10px 0; border-radius:10px">--------</div>
        <a href="https://afdian.com/a/star2moon" target="_blank" style="background:#946ce6; color:white; padding:12px; display:block; text-decoration:none; border-radius:10px; font-weight:bold">å‰å¾€çˆ±å‘ç”µæ”¯æŒ</a>
        <button class="nav-btn" style="width:100%; margin-top:10px" onclick="closeAll()">å¥½çš„</button>
    </div>

    <div id="redeemModal" class="modal">
        <h3>æ‰¾å›å¿ƒæ„¿</h3>
        <input type="text" id="redeemCode" placeholder="è¾“å…¥æå–ç " style="text-transform: uppercase;">
        <button class="nav-btn" style="width:100%" onclick="handleRedeem()">å¼€å§‹æŸ¥æ‰¾</button>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, updateDoc, deleteDoc, doc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // 5ç§’åæ˜¾ç¤ºâ€œè·³è¿‡â€æŒ‰é’®
        setTimeout(() => { document.getElementById('skip-loading').style.display = 'block'; }, 5000);

        const firebaseConfig = {
            apiKey: "AIzaSyCskcwc_od5y7ibmCzhk4BJDbzpq2I_RHQ",
            authDomain: "wishtree-dd4d6.firebaseapp.com",
            projectId: "wishtree-dd4d6",
            storageBucket: "wishtree-dd4d6.firebasestorage.app",
            messagingSenderId: "528466950558",
            appId: "1:528466950558:web:3b8f300319cc7f12cbfe8f"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        let user = null, unsubscribe = null, curX, curY;

        onAuthStateChanged(auth, (u) => {
            if (!u) { 
                signInAnonymously(auth).catch(e => {
                    document.getElementById('loading-status').innerText = "æç¤ºï¼šæ’ä»¶å¯èƒ½æ‹¦æˆªäº†åŒæ­¥";
                });
            } else {
                user = u;
                startListening();
            }
        });

        function startListening() {
            if (unsubscribe) unsubscribe();
            const colRef = collection(db, 'artifacts', 'wish-tree-default', 'public', 'data', 'wishes');
            unsubscribe = onSnapshot(colRef, (snap) => {
                document.getElementById('loading').style.display = 'none';
                renderWishes(snap);
            }, (err) => {
                document.getElementById('loading-status').innerText = "åŒæ­¥å—é™ï¼Œè¯·å°è¯•åˆ·æ–°";
            });
        }

        function renderWishes(snap) {
            const layer = document.getElementById('items-layer');
            layer.innerHTML = '';
            let total = 0, done = 0;
            snap.forEach(d => {
                const data = d.data();
                const isL = data.type === 'flower' || data.type === 'apple';
                const div = document.createElement('div');
                div.className = `item ${isL ? 'size-large' : 'size-small'}`;
                div.style.left = data.x + '%'; div.style.top = data.y + '%';
                div.innerHTML = `
                    <img src="${data.type}.png" onerror="this.src='data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 width=%2220%22 height=%2220%22><circle cx=%2210%22 cy=%2210%22 r=%228%22 fill=%22green%22/></svg>'">
                    <div class="interaction-bar">
                        <div class="nav-btn" style="padding:4px 8px; font-size:10px" onclick="updateDoc(doc(db, 'artifacts', 'wish-tree-default', 'public', 'data', 'wishes', '${d.id}'), {likes: ${(data.likes||0)+1}}), event.stopPropagation()">â¤ï¸ ${data.likes||0}</div>
                        <div class="nav-btn" style="padding:4px 8px; font-size:10px; background:#f44336" onclick="window.handleCancelWish('${d.id}', '${data.passcode}', event)">ğŸ—‘ï¸</div>
                    </div>
                `;
                div.onclick = (e) => {
                    e.stopPropagation();
                    if(div.classList.contains('full-screen')) window.evolveItem(d.id, data.type, data.passcode);
                    else window.openFullScreen(div);
                };
                layer.appendChild(div);
                total++; if(data.type.includes('gold') || data.type === 'apple') done++;
            });
            document.getElementById('total-count').innerText = total;
            document.getElementById('fulfilled-count').innerText = done;
        }

        // å…¨å±€æŒ‚è½½ UI å‡½æ•°
        window.openWishModal = () => { document.getElementById('main-tips').innerText = "âœ¨ è¯·ç‚¹å‡»æ ‘æä½ç½® âœ¨"; };
        window.openRedeemModal = () => { document.getElementById('redeemModal').style.display='block'; document.getElementById('overlay').style.display='block'; };
        document.getElementById('tree-container').onclick = (e) => {
            const rect = e.currentTarget.getBoundingClientRect();
            curX = (e.clientX - rect.left) / rect.width * 100;
            curY = (e.clientY - rect.top) / rect.height * 100;
            document.getElementById('modal').style.display='block';
            document.getElementById('overlay').style.display='block';
        };
        window.confirmWishAndShowPay = async () => {
            const text = document.getElementById('wishText').value;
            const type = document.getElementById('wishType').value;
            if(!text) return;
            const passcode = Math.random().toString(36).substring(2, 10).toUpperCase();
            await addDoc(collection(db, 'artifacts', 'wish-tree-default', 'public', 'data', 'wishes'), {
                x: curX, y: curY, text, type, passcode, likes: 0, blessings: 0, createdAt: new Date()
            });
            document.getElementById('modal').style.display='none';
            document.getElementById('displayPasscode').innerText = passcode;
            document.getElementById('successModal').style.display='block';
        };
        window.handleCancelWish = async (id, code, e) => {
            e.stopPropagation();
            const input = prompt("è¾“å…¥æå–ç ç§»é™¤ï¼š");
            if(input?.toUpperCase() === code) await deleteDoc(doc(db, 'artifacts', 'wish-tree-default', 'public', 'data', 'wishes', id));
        };
        window.openFullScreen = (el) => { 
            closeAll(); document.getElementById('overlay').style.display='block'; el.classList.add('full-screen'); 
        };
        window.closeAll = () => {
            document.querySelectorAll('.item').forEach(i => i.classList.remove('full-screen'));
            document.querySelectorAll('.modal').forEach(m => m.style.display='none');
            document.getElementById('overlay').style.display='none';
        };
        window.closeModal = window.closeAll;
    </script>
</body>
</html>
